<div class="categories-page">
  <h2 class="page-title">Categories</h2>

  @if (selectedBusiness) {
    <mat-card class="category-form-card">
      <h3>Add category</h3>
      <form [formGroup]="categoryForm" (ngSubmit)="onSubmit()">
        <mat-form-field appearance="outline">
          <mat-label>Category name</mat-label>
          <input matInput formControlName="name" placeholder="Utilities" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Description (optional)</mat-label>
          <input matInput formControlName="description" placeholder="Monthly electric bill" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Category kind</mat-label>
          <mat-select formControlName="kind" placeholder="Select a kind">
            @for (option of categoryKindOptions; track option.value) {
              <mat-option [value]="option.value">{{ option.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Parent category (optional)</mat-label>
          <mat-select formControlName="parentCategoryId">
            <mat-option [value]="null">No parent</mat-option>
            @for (option of parentCategoryOptions; track option.id) {
              <mat-option [value]="option.id">
                {{ option.label }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-checkbox formControlName="active">Active</mat-checkbox>

        <div class="actions">
          <button mat-raised-button color="primary" type="submit" [disabled]="categoryForm.invalid || isSaving">
            {{ isSaving ? 'Saving...' : 'Add category' }}
          </button>
        </div>

        @if (formError) {
          <div class="error-message">{{ formError }}</div>
        }
      </form>
    </mat-card>

    <section class="category-list">
      <h3>{{ selectedBusiness.name }} categories</h3>
      @if (isLoading) {
        <div class="state-message">Loading categories...</div>
      }
      @if (errorMessage) {
        <div class="error-message">{{ errorMessage }}</div>
      }
      @if (!isLoading && !errorMessage && categoryTree.length > 0) {
        <mat-list class="category-tree">
          @for (category of categoryTree; track category.id) {
            <ng-container
              *ngTemplateOutlet="categoryNode; context: { $implicit: category, level: 0 }"
            ></ng-container>
          }
        </mat-list>
      }
      @if (!isLoading && !errorMessage && flatCategories.length === 0) {
        <div class="state-message">
          No categories have been created for this business yet.
        </div>
      }
    </section>
  } @else {
    <div class="no-business">
      <p>Select or create a business before managing categories.</p>
    </div>
  }
</div>

<ng-template #categoryNode let-node let-level="level">
  <mat-list-item [ngClass]="{ 'subcategory-item': level > 0 }">
    <div matListItemTitle>{{ node.name }}</div>
    @if (node.description) {
      <div matListItemLine>{{ node.description }}</div>
    }
    <div matListItemLine>Kind: {{ getKindLabel(node.kind) }}</div>
    @if (!node.active) {
      <div matListItemLine class="inactive-label">Inactive</div>
    }
  </mat-list-item>
  @if (node.subcategories.length > 0) {
    <div class="subcategory-list">
      <mat-list>
        @for (child of node.subcategories; track child.id) {
          <ng-container
            *ngTemplateOutlet="categoryNode; context: { $implicit: child, level: level + 1 }"
          ></ng-container>
        }
      </mat-list>
    </div>
  }
</ng-template>
