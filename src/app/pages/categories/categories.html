<div class="categories-page">
  <div class="page-header">
    <div class="page-heading">
      <h1>Categories</h1>
      <p class="page-subtitle">Organize transactions into meaningful groups for better reporting.</p>
    </div>
    <button
      mat-flat-button
      color="primary"
      class="add-category-button"
      type="button"
      (click)="openAddCategoryDialog()"
      [disabled]="!selectedBusiness"
    >
      Add category
    </button>
  </div>

  @if (!selectedBusiness) {
    <section class="state-card">
      <h2>Select a business</h2>
      <p>Choose a business to review and manage categories.</p>
    </section>
  } @else {
    <section class="category-card">
      <div class="card-heading">
        <h2>{{ selectedBusiness.name }} categories</h2>
        <p class="card-subtitle">View the hierarchy of categories configured for this business.</p>
      </div>

      @if (isLoading) {
        <div class="state-message">Loading categories...</div>
      } @else if (errorMessage) {
        <div class="error-message">{{ errorMessage }}</div>
      } @else if (!flatCategories.length) {
        <div class="state-card">
          <h3>No categories yet</h3>
          <p>Create categories to categorize income and expenses.</p>
        </div>
      } @else {
        <div class="category-list-wrapper">
          <mat-list class="category-tree">
            @for (category of categoryTree; track category.id) {
              <ng-container
                *ngTemplateOutlet="categoryNode; context: { $implicit: category, level: 0 }"
              ></ng-container>
            }
          </mat-list>
        </div>
      }
    </section>
  }
</div>

<ng-template #addCategoryDialog>
  <form class="add-category-form" [formGroup]="categoryForm" (ngSubmit)="onSubmit()">
    <h2 mat-dialog-title>Add category</h2>
    <mat-dialog-content>
      <p class="dialog-description">
        Create a new category for {{ selectedBusiness?.name ?? 'this business' }}.
      </p>

      <mat-form-field appearance="outline">
        <mat-label>Category name</mat-label>
        <input matInput formControlName="name" placeholder="Utilities" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Description (optional)</mat-label>
        <input matInput formControlName="description" placeholder="Monthly electric bill" />
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Category kind</mat-label>
        <mat-select formControlName="kind" placeholder="Select a kind">
          @for (option of categoryKindOptions; track option.value) {
            <mat-option [value]="option.value">{{ option.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Parent category (optional)</mat-label>
        <mat-select formControlName="parentCategoryId">
          <mat-option [value]="null">No parent</mat-option>
          @for (option of parentCategoryOptions; track option.id) {
            <mat-option [value]="option.id">
              {{ option.label }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-checkbox formControlName="active">Active</mat-checkbox>

      @if (formError) {
        <div class="error-message">{{ formError }}</div>
      }
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button type="button" (click)="closeAddCategoryDialog()" [disabled]="isSaving">Cancel</button>
      <button mat-flat-button color="primary" type="submit" [disabled]="categoryForm.invalid || isSaving">
        {{ isSaving ? 'Saving...' : 'Add category' }}
      </button>
    </mat-dialog-actions>
  </form>
</ng-template>

<ng-template #categoryNode let-node let-level="level">
  <mat-list-item [ngClass]="{ 'subcategory-item': level > 0 }">
    <div matListItemTitle>{{ node.name }}</div>
    @if (node.description) {
      <div matListItemLine>{{ node.description }}</div>
    }
    <div matListItemLine>Kind: {{ getKindLabel(node.kind) }}</div>
    @if (!node.active) {
      <div matListItemLine class="inactive-label">Inactive</div>
    }
  </mat-list-item>
  @if (node.subcategories.length > 0) {
    <div class="subcategory-list">
      <mat-list>
        @for (child of node.subcategories; track child.id) {
          <ng-container
            *ngTemplateOutlet="categoryNode; context: { $implicit: child, level: level + 1 }"
          ></ng-container>
        }
      </mat-list>
    </div>
  }
</ng-template>
